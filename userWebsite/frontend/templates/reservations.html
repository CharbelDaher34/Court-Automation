{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reserve Court Section</title>
  </head>
  <script src="{% static 'js/reservations.js' %}"></script>

  <style>
    body {
      font-family: Arial, sans-serif; /* Ensures text is in Arial, if not available then sans-serif */
      text-align: center; /* Centers all the text inside the body */
      font-size: 18px; /* Increases the font size */
    }
    
    h1,
    h2,
    h3 {
      margin-top: 20px; /* Adds space above each heading */
    }
    
    ul {
      list-style-type: none; /* Removes bullet points from list */
      padding: 0; /* Removes padding */
    }
    
    li {
      margin-bottom: 10px; /* Adds space below each list item */
    }
    
    form {
      margin-top: 20px; /* Adds space above the form */
    }
    
    button {
      font-size: 16px; /* Larger font size for better readability */
      padding: 10px 20px; /* Padding around the text in the button */
      cursor: pointer; /* Shows a pointer cursor on hover */
      width: 200px;
      height: 30px;
      margin: 5px;
    }
    
    /* Overall form styling */
    #reserveForm {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 300px;
      margin: 0 auto; /* Center the form horizontally */
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-family: sans-serif;
    }
    
    /* Labels and inputs */
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    input[type='email'],
    input[type='password'],
    input[type='time'] {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 16px;
    }
    
    /* Password toggle eye icon */
    #togglePassword {
      cursor: pointer;
      margin-left: 5px;
    }
    
    /* Button */
    #reserveButton {
      background-color: #4caf50; /* Green color */
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 15px;
    }
    
    /* Button hover effect */
    #reserveButton:hover {
      background-color: #45a049; /* Slightly darker green on hover */
    }
  </style>

  <body onload="init()">
    <h1>Reserve Court Section</h1>
    <h2>Court Section: {{ court_section.sectionName }}</h2>
    <h2>Date: {{ date }}</h2>

    <h3>Available Time Slots:</h3>
    <ul>
      {% for slot in available_slots %}
        <li>{{ slot }}</li>
      {% endfor %}
    </ul>

    <h3>Reserve Time Slot:</h3>

    <div id="reserveForm">
      <label for="email">Email:</label>
      <input type="email" id="email" name="email" /><br /><br />
      <label for="password">Password:</label>
      <input type="password" id="password" name="password" />

      <input type="hidden" name="available_slots" value="{{ available_slots }}" id="slots" />
      <p>
        <label for="startTime">Start Time:</label>
        <input type="time" name="start_time" required="" id="startTime" />
      </p>
      <p>
        <label for="endTime">End Time:</label>
        <input type="time" name="end_time" required="" id="endTime" />
      </p>
      <button id="reserveButton" onclick="checkAvailability()">Reserve</button>
    </div>

    <button id="show" onclick="showForm()">create user</button>

    <form id="userCreationForm" method="post" enctype="multipart/form-data">
      {% comment %}action="{% url 'submit_user_creation_form' %}">{% endcomment %} {% csrf_token %}
      <input type="hidden" id="courtSectionId" name="courtSectionId" value="{{ court_section.courtSectionId }}" />
      <input type="hidden" id="date" name="date" value="{{ date }}" />

      <label for="firstName">First Name:</label><br />
      <input type="text" id="firstName" name="firstName" /><br /><br />

      <label for="lastName">Last Name:</label><br />
      <input type="text" id="lastName" name="lastName" /><br /><br />

      <label for="email">Email:</label><br />
      <input type="email" id="userCreationemail" name="email" /><br /><br />

      <label for="password">Password:</label>
      <input type="password" id="userCreationPassword" name="password" />

      <label for="number">Phone Number:</label><br />
      <input type="tel" id="number" name="number" placeholder="Format: 123-456-7890" /><br /><br />

      <label for="country">Country:</label><br />
      <input type="text" id="country" name="country" /><br /><br />

      <label for="address">Address:</label><br />
      <input type="text" id="address" name="address" /><br /><br />

      <label for="date_of_birth">Date of Birth:</label><br />
      <input type="date" id="date_of_birth" name="date_of_birth" /><br /><br />

      <label for="sex">Sex:</label><br />
      <select id="sex" name="sex">
        <option value="M">Male</option>
        <option value="F">Female</option>
      </select>
      <br /><br />

      <br /><br /><br />
      <input type="button" value="creeate" onclick="create_user()" />
      {% comment %} <button type="submit">submit</button> {% endcomment %}
    </form>

    <br /><br /><br />
    <div id="addFaceForm">
      <label for="userFace">If you want to be authenticated using your face upload a photo of your face only, and make sure it is not so close to your face:</label><br />
      <label for="emailFace">Email:</label><br />
      <input type="email" id="emailFace" /><br /><br />

      <input type="file" name="userFace" id="userFace" accept="image/*" />
      <br />
      <button id="uploadButton">Add face</button>
    </div>
    <button onload="showFormFace()">add face</button>

    <footer>
      <p></p>
    </footer>
  </body>

  <script>
    function showFormFace() {
      alert('')
      var faceAddForm = document.getElementById('addFaceForm')
      if (faceAddForm.style.display === 'block') {
        faceAddForm.style.display = 'none' // Hide the form
      } else {
        faceAddForm.style.display = 'block' // Show the form
      }
    }
    function init() {
      document.getElementById('userCreationForm').style.display = 'none'
      document.getElementById('addFaceForm').style.display = 'none'
    }
  async   function checkAvailability() {
      var startTime = document.getElementById('startTime').value
      var endTime = document.getElementById('endTime').value
      let available_slots = document.getElementById('slots').value
      // Convert startTime and endTime to integers
      let [hours, minutes] = startTime.split(':')
      let startHour = parseInt(hours)
      let startMin = (parseInt(minutes)[(hours, minutes)] = endTime.split(':'))
      let endHour = parseInt(hours)
      let endMin = parseInt(minutes)
    
      // Convert available_slots to a list of tuples of integers
      let stringData = available_slots.replace(/\[|\]|\(/g, '')
      let dataArray = stringData.replace(/'/g, '').split('),')
      dataArray = dataArray.map((item) => item.trim())
      parts = dataArray[0].split(',').map((part) => part.trim())
      available_slots = parts.map((part) => {
        let [hour, minute] = part.split(':').map((num) => parseInt(num))
        return [hour, minute]
      })
    
      available_slots = groupPairs(available_slots)
      let isAvailable = false // Initialize availability flag to false
    
      for (let i = 0; i < available_slots.length; i = i + 1) {
        let slot = available_slots[i]
    
        let slotStartHour = slot[0][0]
        let slotStartMin = slot[0][1]
        let slotEndHour = slot[1][0]
        let slotEndMin = slot[1][1]
    
        // Check if start time falls within the current available slot
        if (
          (startHour > slotStartHour || (startHour === slotStartHour && startMin >= slotStartMin)) &&
          // Check if end time also falls within the current available slot
          (endHour < slotEndHour || (endHour === slotEndHour && endMin <= slotEndMin))
        ) {
          isAvailable = true // Slot found, set flag to true
          break // Exit the loop once a slot is found
        } else {
          // No match, continue checking other slots
        }
      }
    
      var courtSectionId = '{{ court_section.courtSectionId }}'
      var date = '{{ date }}'
    
      var email = document.getElementById('email').value
      var password = document.getElementById('password').value
    
      var requestData = {
        email: email,
        password: password,
        courtSectionId: courtSectionId,
        startTime: startTime,
        endTime: endTime,
        date: date
      }
      alert('before')
      try {
        alert("in");
        response = await fetch('http://localhost:8000/frontend/reserve_court_section/' + courtSectionId + '/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        })
      } catch (error) {
        alert('error:' + error)
      }
      data= await response.json()
      alert(data['message'])
      alert('batata' + response.ok)
      if (response.status==200) {
        alert("saf");
        window.location.href = 'http://localhost:8000/frontend/home/';

        fetch('http://localhost:8000/frontend/home/', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        })
      }
    }
    
    // Assuming you have an HTML file with an input field for the image and a button to trigger the API call
    
    // Function to handle the API call
    async function callAPI() {
      // Get the file input element
      const fileInput = document.getElementById('userFace')
      const email = document.getElementById('emailFace').value
      // Get the file selected by the user
      const file = fileInput.files[0]
    
      // Create a FormData object to send the file
      const formData = new FormData()
      formData.append('image', file)
      formData.append('identity', email)
      alert('dsfsd')
      // Send HTTP POST request
      const url = 'http://127.0.0.1:5000/embeddingCreation' // Replace with your API endpoint
      try {
        response = await fetch(url, {
          method: 'POST',
          body: formData
        })
      } catch (error) {
        alert('asfasfasf' + error)
      }
      data = await response.json() // Parse the JSON response
      alert(typeof data + ' ' + data)
    
      if (parseInt(data) === 1) {
        alert('face added successfully to your email')
      }
      if (parseInt(data) === 2) {
        alert('make sure you are the only one in the photo')
      }
      if (parseInt(data) === 0) {
        alert('make sure there is a face in the photo')
      }
    }
    
    // Attach an event listener to the button to trigger the API call
    const button = document.getElementById('uploadButton')
    button.addEventListener('click', callAPI)
    
    async function create_user() {
      // Create an object to store the form data
      let formData = {}
    
      // Get the values of the hidden inputs
      formData.courtSectionId = document.getElementById('courtSectionId').value
      formData.date = document.getElementById('date').value
    
      // Get the values of the text inputs
      formData.firstName = document.getElementById('firstName').value
      formData.lastName = document.getElementById('lastName').value
      formData.email = document.getElementById('userCreationemail').value
      formData.password = document.getElementById('userCreationPassword').value
      formData.number = document.getElementById('number').value
      formData.country = document.getElementById('country').value
      formData.address = document.getElementById('address').value
      formData.date_of_birth = document.getElementById('date_of_birth').value
    
      // Get the selected value from the dropdown
      formData.sex = document.getElementById('sex').value
      const jsonData = JSON.stringify(formData) // Convert the form data to a JSON string
    
      try {
        response = await fetch('http://localhost:8000/backend/create_user/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
            // Add any other headers if required, such as CSRF token
          },
          body: jsonData
        })
    
        const responseData = await response.json()
    
        alert(responseData.message)
        // Handle the response data as needed, such as displaying messages to the user
      } catch (error) {
        alert('Error:', error)
        // Handle errors, such as displaying an error message to the user
      }
    }
  </script>
</html>
