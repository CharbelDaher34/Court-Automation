{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reserve Court Section</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap">
  </head>
  <script src="{% static 'js/reservations.js' %}"></script>

  <style>
    body {
      font-family: 'Roboto', sans-serif; /* Ensures text is in Arial, if not available then sans-serif */
      text-align: center; /* Centers all the text inside the body */
      font-size: 18px; /* Increases the font size */
      margin: 0;
      padding: 0;
      
    }
    header {
    text-align: center;
    background-color: #2da27fdd;
    color:#fff;
    padding:5px;
    box-shadow: rgba(0, 0, 0, 0.2);
    position: sticky;
    top:0;
    width:100%;
    z-index: 1000;
    
  

  }
    h1,
    h2,
    h3 {
      margin-top: 20px; /* Adds space above each heading */
      font-family: 'Roboto',sans-serif;
    }
    h2{
      color: #e26110;
      font-family: 'Roboto',sans-serif;
        }
    h4{
      font-weight: normal;
    }
    
    ul {
      list-style-type: none; /* Removes bullet points from list */
      padding: 0; /* Removes padding */
    }
    
    li {
      margin-bottom: 10px; /* Adds space below each list item */
    }
    
    form {
      margin-top: 20px; /* Adds space above the form */
      border-color: #2da27fdd;
      
    }
    
    button {
      
      padding: 20px 20px; /* Padding around the text in the button */
      cursor: pointer; /* Shows a pointer cursor on hover */
      width: 200px;
      height: 30px;
      margin: 5px;
      transition: background-color 0.3s ease;
      background-color: #2da27fdd;
      color: white;

      
      border: none;
      border-radius: 25px;
   
      margin-top: 15px;
      margin-bottom: 15px;
      font-size: 20px;
      display: flex;
      text-align: center;
      justify-content: center;
      align-items: center;
      margin:auto;

    }
    button:hover{
      background-color: #23795fdd; 
    }
    
    /* Overall form styling */
    #reserveForm,#userCreationForm,#addFaceForm {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 60%;
      margin: 0 auto; /* Center the form horizontally */
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-family: sans-serif;
      background-color: #f7f7f7;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
      
      
    }
    
    /* Labels and inputs */
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color:#333;
    }
    
    input[type='email'],
    input[type='password'],
    input[type='time'],
    input[type='text'],
    input[type='tel'],
    input[type='date'],
    select {
      width:60%;
      padding: 10px;
      border: 1px solid #2da27fdd;
      border-radius: 5px;
      font-size: 16px;
      margin-bottom: 15px;
    }
    input[type='time'],
    input[type='date'],
    input[type='tel'],
    select
    {
      height: fit-content;
      width: fit-content;
    }

    input:focus{
      border-color: #2da27fdd;
      box-shadow: 0 0 5px rgba(45,162,127,0.5);
      outline:none;
    }
    
    /* Password toggle eye icon */
    #togglePassword {
      cursor: pointer;
      margin-left: 5px;
    }
    
    /* Button */
    #reserveButton, input[type='button']{
      all:unset;
      background-color: #2da27fdd; /* Green color */
      color: white;
       
       padding: 7px 13px;
     
      border: none;
      
      border-radius: 25px;
      cursor: pointer;
      
      margin-top: 15px;
      margin-bottom: 15px;
      
      font-size: 20px;
      
      width:180px;
      height:25px;
      display: flex;
      text-align: center;
      justify-content: center;
      align-items: center;
     
      margin: auto;
      
    }


    
    /* Button hover effect */
    #reserveButton:hover,input[type='button']:hover {
      background-color: #23795fdd; /* Slightly darker green on hover */
    }
   
    
  </style>

  <body onload="init()">
    <header class="header">
        
      <h1>Court Section Reservation</h1>
      
    </header>
    <h2>Court Section: {{ court_section.sectionName }}</h2>
    <h2>Date: {{ date }}</h2>

    <h3>Available Time Slots:</h3>
    <ul>
      {% for slot in available_slots %}
        <li>{{ slot }}</li>
      {% endfor %}
    </ul>

    <h3>Reserve Time Slot:</h3>
    <h4>Already have an account? <b style="color: #2da27fdd;"> Proceed with your reservation.</b></h4>

    <div id="reserveForm">
      <label for="email">Email:</label>
      <input type="email" id="email" name="email" /><br /><br />
      <label for="password">Password:</label>
      <input type="password" id="password" name="password" />

      <input type="hidden" name="available_slots" value="{{ available_slots }}" id="slots" />
      <p>
        <label for="startTime">Start Time:</label>
        <input type="time" name="start_time" required="" id="startTime" />
      </p>
      <p>
        <label for="endTime">End Time:</label>
        <input type="time" name="end_time" required="" id="endTime" /><br>
      </p>
      <button id="reserveButton" onclick="checkAvailability()">Reserve</button>
    </div>
    <p>Don't have an account? <b id="signup-link" style="color:#2da27fdd ; cursor:pointer">Sign up to proceed with your reservation.</b></p>
    

    <form id="userCreationForm" method="post" enctype="multipart/form-data">
      {% comment %}action="{% url 'submit_user_creation_form' %}">{% endcomment %} {% csrf_token %}
      <input type="hidden" id="courtSectionId" name="courtSectionId" value="{{ court_section.courtSectionId }}" />
      <input type="hidden" id="date" name="date" value="{{ date }}" />

      <label for="firstName">First Name:</label><br />
      <input type="text" id="firstName" name="firstName" /><br /><br />

      <label for="lastName">Last Name:</label><br />
      <input type="text" id="lastName" name="lastName" /><br /><br />

      <label for="email">Email:</label><br />
      <input type="email" id="userCreationemail" name="email" /><br /><br />

      <label for="password">Password:</label>
      <input type="password" id="userCreationPassword" name="password" />

      <label for="number">Phone Number:</label><br />
      <input type="tel" id="number" name="number" placeholder="Format: 123-456-7890" /><br /><br />

      <label for="country">Country:</label><br />
      <input type="text" id="country" name="country" /><br /><br />

      <label for="address">Address:</label><br />
      <input type="text" id="address" name="address" /><br /><br />

      <label for="date_of_birth">Date of Birth:</label><br />
      <input type="date" id="date_of_birth" name="date_of_birth" /><br /><br />

      <label for="sex">Sex:</label><br />
      <select id="sex" name="sex">
        <option value="M">Male</option>
        <option value="F">Female</option>
      </select>
      <br /><br />

      <br /><br /><br />
      <input type="button" value="Create" onclick="create_user()" />
      {% comment %} <button type="submit">submit</button> {% endcomment %}
    </form>

    <br /><br /><br />
    <div id="addFaceForm">
      <label for="userFace">If you want to be authenticated using your face, upload a photo of your face only, and make sure it is not too close to your face:</label><br />
      <label for="emailFace">Email:</label><br />
      <input type="email" id="emailFace" /><br /><br />

      <input type="file" name="userFace" id="userFace" accept="image/*" />
      <br /><br /><br />
      <button id="uploadButton">Upload Image</button>
    </div>
    <br><br>
    <button onclick="showFormFace()">Add Face</button>

    <footer>
      <p></p>
    </footer>
  </body>

  <script>
    function showFormUser() {
      var CreateUserForm = document.getElementById('userCreationForm')
      if (CreateUserForm.style.display === 'block') {
        CreateUserForm.style.display = 'none' // Hide the form
      } else {
        CreateUserForm.style.display = 'block' // Show the form
      }
    }

    document.getElementById('signup-link').addEventListener('click',showFormUser);
    function showFormFace() {
      var faceAddForm = document.getElementById('addFaceForm')
      if (faceAddForm.style.display === 'block') {
        faceAddForm.style.display = 'none' // Hide the form
      } else {
        faceAddForm.style.display = 'block' // Show the form
      }
    }

    
    function init() {
      document.getElementById('userCreationForm').style.display = 'none'
      document.getElementById('addFaceForm').style.display = 'none'
    }
    async function checkAvailability() {
      var startTime = document.getElementById('startTime').value
      var endTime = document.getElementById('endTime').value
      let available_slots = document.getElementById('slots').value
      // Convert startTime and endTime to integers
      let [hours, minutes] = startTime.split(':')
      let startHour = parseInt(hours)
      let startMin = (parseInt(minutes)[(hours, minutes)] = endTime.split(':'))
      let endHour = parseInt(hours)
      let endMin = parseInt(minutes)
      var courtSectionId = '{{ court_section.courtSectionId }}'
      var date = '{{ date }}'
    
      var email = document.getElementById('email').value
      var password = document.getElementById('password').value
    
      var availableSlots = {{ available_slots|safe }};


      var requestData = {
        email: email,
        password: password,
        courtSectionId: courtSectionId,
        startTime: startTime,
        endTime: endTime,
        date: date,
        availableSlots:availableSlots
      }
      try {
        response = await fetch('http://localhost:8000/frontend/reserve_court_section/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        })
      } catch (error) {
        alert('error:' + error)
      }
      data= await response.json()
      if (response.status==200) {

        token=data.token;
price=data.price;
        const link = document.createElement("a");
        const content = `${startTime}-->${endTime}\n${email}\nToken: ${token}\nPrice: $${price}\nDate: ${date} `;        
        const file = new Blob([content], { type: 'text/plain' });
        link.href = URL.createObjectURL(file);
        link.download = "reservation.txt";
        link.click();
        URL.revokeObjectURL(link.href);


        window.location.href = 'http://localhost:8000/frontend/home/';

        fetch('http://localhost:8000/frontend/home/', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        })
      }
    }
    
    // Assuming you have an HTML file with an input field for the image and a button to trigger the API call
    
    // Function to handle the API call
    async function callAPI() {
      // Get the file input element
      const fileInput = document.getElementById('userFace')
      const email = document.getElementById('emailFace').value
      // Get the file selected by the user
      const file = fileInput.files[0]
    
      // Create a FormData object to send the file
      const formData = new FormData()
      formData.append('image', file)
      formData.append('identity', email)
      // Send HTTP POST request
      const url = 'http://127.0.0.1:5000/embeddingCreation' // Replace with your API endpoint
      try {
        response = await fetch(url, {
          method: 'POST',
          body: formData
        })
      } catch (error) {
        alert('' + error)
      }
      data = await response.json() // Parse the JSON response
    
      if (parseInt(data) === 1) {
        alert('face added successfully to your email')
      }
      if (parseInt(data) === 2) {
        alert('make sure you are the only one in the photo')
      }
      if (parseInt(data) === 0) {
        alert('make sure there is a face in the photo')
      }
    }
    
    // Attach an event listener to the button to trigger the API call
    const button = document.getElementById('uploadButton')
    button.addEventListener('click', callAPI)
    
    async function create_user() {
      // Create an object to store the form data
      let formData = {}
    
      // Get the values of the hidden inputs
      formData.courtSectionId = document.getElementById('courtSectionId').value
      formData.date = document.getElementById('date').value
    
      // Get the values of the text inputs
      formData.firstName = document.getElementById('firstName').value
      formData.lastName = document.getElementById('lastName').value
      formData.email = document.getElementById('userCreationemail').value
      formData.password = document.getElementById('userCreationPassword').value
      formData.number = document.getElementById('number').value
      formData.country = document.getElementById('country').value
      formData.address = document.getElementById('address').value
      formData.date_of_birth = document.getElementById('date_of_birth').value
    
      // Get the selected value from the dropdown
      formData.sex = document.getElementById('sex').value
      const jsonData = JSON.stringify(formData) // Convert the form data to a JSON string
    
      try {
        response = await fetch('http://localhost:8000/backend/create_user/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
            // Add any other headers if required, such as CSRF token
          },
          body: jsonData
        })
    
        const responseData = await response.json()
        alert(responseData.message)
       
    
        // Handle the response data as needed, such as displaying messages to the user
      } catch (error) {
        alert('Error:', error)
        // Handle errors, such as displaying an error message to the user
      }
    }
  </script>
</html>
